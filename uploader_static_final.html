<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>File Uploader for Google Sheets</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .form-input {
      @apply w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500;
    }
    .btn {
      @apply px-4 py-2 font-semibold rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800;
    }
    .btn-primary {
      @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
    }
    .btn-secondary {
      @apply bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500;
    }
    .btn-google {
      @apply bg-white text-gray-700 hover:bg-gray-100 flex items-center justify-center gap-3;
    }
    #log-area {
      height: 150px;
      font-family: 'Courier New', Courier, monospace;
    }
  </style>
</head>
<body class="bg-gray-800 text-gray-200 flex items-center justify-center min-h-screen p-4"
      data-api-key="AIzaSyCJEPhiRRAKbQ0XBF2sz6VU1SMgjv7fDUU"
      data-client-id="676119033002-hlju42faeo2b9fkj1lorkch38ksj2kng.apps.googleusercontent.com">

<!-- Content and script identical to previous version -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<script>
  const API_KEY = document.body.dataset.apiKey;
  const CLIENT_ID = document.body.dataset.clientId;
  const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';
  let tokenClient, gapiInited = false, gisInited = false;

  const authSection = document.getElementById('auth-section');
  const uploaderSection = document.getElementById('uploader-section');
  const authorizeButton = document.getElementById('authorize_button');
  const signoutButton = document.getElementById('signout_button');
  const uploadButton = document.getElementById('upload-button');
  const logArea = document.getElementById('log-area');

  window.onload = () => {
    log('Current Origin: ' + window.location.origin);
    authorizeButton.onclick = handleAuthClick;
    signoutButton.onclick = handleSignoutClick;
    uploadButton.onclick = handleUploadClick;
    gapi.load('client', initializeGapiClient);
    gisLoaded();
  };

  async function initializeGapiClient() {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: [
        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
        'https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest'
      ],
    });
    gapiInited = true;
    maybeEnableButtons();
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: tokenCallback,
    });
    gisInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      authorizeButton.disabled = false;
      log('Ready to sign in.');
    } else {
      authorizeButton.disabled = true;
    }
  }

  function handleAuthClick() {
    const token = gapi.client.getToken();
    tokenClient.requestAccessToken({ prompt: token ? '' : 'consent' });
  }

  function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token) {
      google.accounts.oauth2.revoke(token.access_token);
      gapi.client.setToken('');
      updateUiForAuthState(false);
      log('User signed out.');
    }
  }

  function tokenCallback(resp) {
    if (resp.error !== undefined) {
      log('ERROR: ' + JSON.stringify(resp, null, 2));
      return;
    }
    updateUiForAuthState(true);
    log('Authentication successful.');
  }

  function updateUiForAuthState(isSignedIn) {
    authSection.classList.toggle('hidden', isSignedIn);
    uploaderSection.classList.toggle('hidden', !isSignedIn);
    signoutButton.classList.toggle('hidden', !isSignedIn);
  }

  async function handleUploadClick() {
    const spreadsheetId = document.getElementById('spreadsheet-id').value;
    const range = document.getElementById('sheet-range').value;
    const fileInput = document.getElementById('file-input');
    if (!spreadsheetId || !range || fileInput.files.length === 0) {
      log('Missing required info.');
      return;
    }

    const file = fileInput.files[0];
    uploadButton.disabled = true;
    uploadButton.textContent = 'Uploading...';

    try {
      const driveResponse = await uploadFileToDrive(file);
      await makeFilePublic(driveResponse.id);
      const fileLink = await getDriveFileLink(driveResponse.id);
      await appendDataToSheet(spreadsheetId, range, file.name, fileLink);
      log('Successfully uploaded and linked!');
    } catch (error) {
      const errorMessage = error.result ? error.result.error.message : error.message;
      log(`ERROR: ${errorMessage}`);
      console.error(error);
    } finally {
      uploadButton.disabled = false;
      uploadButton.textContent = 'Upload File';
    }
  }

  function uploadFileToDrive(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsArrayBuffer(file);
      reader.onload = async (e) => {
        try {
          const response = await gapi.client.drive.files.create({
            resource: { name: file.name, mimeType: file.type },
            media: { mimeType: file.type, body: e.target.result },
            fields: 'id',
          });
          resolve(response.result);
        } catch (error) {
          reject(error);
        }
      };
    });
  }

  async function makeFilePublic(fileId) {
    await gapi.client.drive.permissions.create({
      fileId: fileId,
      resource: { role: 'reader', type: 'anyone' },
    });
  }

  async function getDriveFileLink(fileId) {
    const response = await gapi.client.drive.files.get({
      fileId: fileId,
      fields: 'webViewLink'
    });
    return response.result.webViewLink;
  }

  async function appendDataToSheet(spreadsheetId, range, fileName, fileLink) {
    const values = [[fileName, fileLink, new Date().toLocaleString()]];
    const body = { values };
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId,
      range,
      valueInputOption: 'USER_ENTERED',
      resource: body,
    });
  }

  function log(message) {
    const timestamp = new Date().toLocaleTimeString();
    logArea.innerHTML = `[${timestamp}] ${message}
` + logArea.innerHTML;
  }
</script>
</body>
</html>