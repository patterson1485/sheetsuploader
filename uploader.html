<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Uploader for Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-input {
            @apply w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .btn {
            @apply px-4 py-2 font-semibold rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500;
        }
        .btn-google {
            @apply bg-white text-gray-700 hover:bg-gray-100 flex items-center justify-center gap-3;
        }
        #log-area {
            height: 150px;
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-gray-900 p-8 rounded-xl shadow-2xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-white">Upload File to Google Sheet</h1>
            <p class="text-gray-400 mt-1">Uploads a file to Drive & adds a link to Sheets.</p>
        </header>

        <!-- Authentication Section -->
        <div id="auth-section" class="text-center">
            <p class="mb-4 text-gray-300">Please sign in with your Google Account to continue.</p>
            <button id="authorize_button" class="btn btn-google w-full md:w-auto">
                <svg class="w-5 h-5" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.089,5.571l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Sign In with Google
            </button>
            <button id="signout_button" class="hidden btn btn-secondary mt-4">Sign Out</button>
        </div>

        <!-- Uploader Section -->
        <div id="uploader-section" class="hidden space-y-4">
            <div>
                <label for="spreadsheet-id" class="block text-sm font-medium text-gray-300 mb-1">Google Spreadsheet ID</label>
                <input type="text" id="spreadsheet-id" class="form-input" placeholder="e.g., 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
            </div>
            <div>
                <label for="sheet-range" class="block text-sm font-medium text-gray-300 mb-1">Sheet Name & Range</label>
                <input type="text" id="sheet-range" class="form-input" value="Sheet1!A1" placeholder="e.g., Sheet1!A1">
            </div>
            <div>
                <label for="file-input" class="block text-sm font-medium text-gray-300 mb-1">File to Upload</label>
                <input type="file" id="file-input" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <button id="upload-button" class="btn btn-primary w-full">Upload File</button>
        </div>

        <!-- Log Area -->
        <div class="mt-6">
             <label class="block text-sm font-medium text-gray-400 mb-1">Status Log</label>
             <div id="log-area" class="w-full bg-gray-950 rounded-md p-3 text-sm text-gray-300 overflow-y-auto border border-gray-700">Waiting for user action...</div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script type="text/javascript">
        // --- IMPORTANT ---
        // Your API Key and Client ID have been added below.
        const API_KEY = 'AIzaSyCwK378jB-jXGQmVFip_R9i8syk0z0UB-E';
        const CLIENT_ID = '676119033002-hlju42faeo2b9fkj1lorkch38ksj2kng.apps.googleusercontent.com';

        // Scopes required for the application.
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const uploaderSection = document.getElementById('uploader-section');
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const uploadButton = document.getElementById('upload-button');
        const logArea = document.getElementById('log-area');

        // --- Initialization ---
        
        window.onload = () => {
            // Log the origin so we know what to authorize
            log('Current Origin: ' + window.location.origin);
        
            // Load the GAPI client script
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.onload = gapiLoaded;
            document.body.appendChild(gapiScript);

            // Load the GIS client script
            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.onload = gisLoaded;
            document.body.appendChild(gisScript);

            // Add event listeners
            authorizeButton.onclick = handleAuthClick;
            signoutButton.onclick = handleSignoutClick;
            uploadButton.onclick = handleUploadClick;
        };

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            if (!API_KEY) {
                log('ERROR: API_KEY is not set. Please update the script.');
                return;
            }
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [
                    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                    'https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest'
                ],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            if (!CLIENT_ID) {
                log('ERROR: CLIENT_ID is not set. Please update the script.');
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: tokenCallback,
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.disabled = false;
                log('Ready to sign in.');
            } else {
                 authorizeButton.disabled = true;
            }
        }

        // --- Authentication ---

        function handleAuthClick() {
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateUiForAuthState(false);
                log('User signed out.');
            }
        }
        
        function tokenCallback(resp) {
            if (resp.error !== undefined) {
                log('ERROR: ' + JSON.stringify(resp, null, 2));
                throw (resp);
            }
            updateUiForAuthState(true);
            log('Authentication successful.');
        }
        
        function updateUiForAuthState(isSignedIn) {
            if (isSignedIn) {
                authSection.classList.add('hidden');
                uploaderSection.classList.remove('hidden');
                signoutButton.classList.remove('hidden');
            } else {
                authSection.classList.remove('hidden');
                uploaderSection.classList.add('hidden');
                signoutButton.classList.add('hidden');
            }
        }

        // --- Core Logic ---

        async function handleUploadClick() {
            const spreadsheetId = document.getElementById('spreadsheet-id').value;
            const range = document.getElementById('sheet-range').value;
            const fileInput = document.getElementById('file-input');

            if (!spreadsheetId || !range) {
                log('ERROR: Spreadsheet ID and Range are required.');
                return;
            }
            if (fileInput.files.length === 0) {
                log('ERROR: Please select a file to upload.');
                return;
            }

            const file = fileInput.files[0];
            log(`Starting upload for: ${file.name}`);
            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';

            try {
                // Step 1: Upload file to Google Drive
                const driveResponse = await uploadFileToDrive(file);
                log(`File uploaded to Drive. File ID: ${driveResponse.id}`);

                // Step 2: Make the file public (anyone with the link can view)
                await makeFilePublic(driveResponse.id);
                log('File permissions updated to public.');

                // Step 3: Get the file's web link
                const fileLink = await getDriveFileLink(driveResponse.id);
                log(`File link: ${fileLink}`);
                
                // Step 4: Append the file name and link to Google Sheets
                await appendDataToSheet(spreadsheetId, range, file.name, fileLink);
                log('Successfully updated Google Sheet!');

            } catch (error) {
                const errorMessage = error.result ? error.result.error.message : error.message;
                log(`ERROR: ${errorMessage}`);
                console.error(error);
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload File';
            }
        }
        
        function uploadFileToDrive(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = async (e) => {
                    const fileContent = e.target.result;
                    const resource = {
                        name: file.name,
                        mimeType: file.type,
                    };

                    try {
                        const response = await gapi.client.drive.files.create({
                            resource: resource,
                            media: {
                                mimeType: file.type,
                                body: fileContent,
                            },
                            fields: 'id',
                        });
                        resolve(response.result);
                    } catch (error) {
                        reject(error);
                    }
                };
            });
        }
        
        async function makeFilePublic(fileId) {
             await gapi.client.drive.permissions.create({
                fileId: fileId,
                resource: {
                    role: 'reader',
                    type: 'anyone'
                }
            });
        }
        
        async function getDriveFileLink(fileId) {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                fields: 'webViewLink'
            });
            return response.result.webViewLink;
        }

        async function appendDataToSheet(spreadsheetId, range, fileName, fileLink) {
            const values = [
                [fileName, fileLink, new Date().toLocaleString()]
            ];
            const body = {
                values: values,
            };

            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: spreadsheetId,
                range: range,
                valueInputOption: 'USER_ENTERED',
                resource: body,
            });
        }

        // --- Utility ---

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML = `[${timestamp}] ${message}\n` + logArea.innerHTML;
        }

    </script>
</body>
</html>
